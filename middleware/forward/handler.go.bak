package forward

import (
	"fmt"
	"regexp"
	"strconv"
	"strings"

	"github.com/gin-gonic/gin"
	"github.com/kwaain/nakisama/lib/api"
	"github.com/kwaain/nakisama/lib/conf"
	"github.com/kwaain/nakisama/lib/logger"
	"github.com/kwaain/nakisama/middleware/event"
	"go.uber.org/zap"
)

// Handler æ˜¯ forward ä¸»é€»è¾‘ã€‚
//
// å½“æ”¶åˆ°æ–°çš„è¯·æ±‚äº‹ä»¶æ—¶ï¼ŒHandler ä¼šè½¬å‘è¯¥è¯·æ±‚ç»™ bot ç®¡ç†å‘˜ã€‚
// åœ¨è½¬å‘è¯·æ±‚äº‹ä»¶æ—¶ï¼ŒHandler ä¼šåœ¨è½¬å‘æ­£æ–‡çš„å°¾éƒ¨æ·»åŠ ä¸€ä¸ª SessionIDï¼Œå®ƒåŒ…å«è¯¥è¯·æ±‚äº‹ä»¶çš„å¿…è¦ä¿¡æ¯ã€‚è¯¦è§ newSessionID()ã€‚
//
// å½“æ”¶åˆ°æ–°çš„æ¶ˆæ¯äº‹ä»¶æ—¶ï¼ŒHandler ä¼šé€šè¿‡ SessionID åˆ¤æ–­è¯¥æ¶ˆæ¯æ˜¯å¦ä¸ºå¯¹äºè¯·æ±‚äº‹ä»¶çš„å“åº”æ“ä½œã€‚è¿›è€Œæ‰§è¡Œè¯¥å“åº”æ“ä½œã€‚
//
// å½“æ”¶åˆ°æ–°çš„é€šçŸ¥äº‹ä»¶æ—¶ï¼ŒHandler ä¼šé€šè¿‡
func Handler() gin.HandlerFunc {
	return func(c *gin.Context) {
		requestID := c.MustGet("requestID").(string)
		logger.Debug("è¿›å…¥ä¸­é—´ä»¶ forward", zap.String("requestID", requestID))

		switch e := c.MustGet("event").(type) {
		// æ±‚äº‹ä»¶
		case event.RequestEvent:
			switch e.RequestType {
			case "friend":
				sessionID := newRequestSessionID(e.RequestType, e.Flag)

				param := api.SendPrivateMsgParam{
					UserID:  conf.Get().Admin[0],
					Message: newFriendRequestStr(requestID, sessionID, e.UserID, e.Comment),
				}
				resp, err := api.SendPrivateMsg(param)
				if err != nil {
					logger.Error("è¯·æ±‚äº‹ä»¶è½¬å‘å¤±è´¥", zap.String("requestID", requestID), zap.Error(err))

					c.Abort()
					return
				}

				logger.Info("è¯·æ±‚äº‹ä»¶è½¬å‘æˆåŠŸ", zap.String("requestID", requestID), zap.Float64("messageID", resp.MessageID))
				c.Abort()
				return

			case "group":

			default:
			}

		// é€šçŸ¥äº‹ä»¶è½¬å‘
		case event.NoticeEvent:
			switch e.NoticeType {
			case event.FriendAdd:

			case event.GroupAdmin:

			default:
			}

		// å¦‚æœä¸€æ¡æ¶ˆæ¯æ˜¯å¯¹äºè¯·æ±‚äº‹ä»¶çš„å“åº”ï¼Œåˆ™ä¼šå¤„ç†
		case event.MessageEvent:
			// æ˜¯å¦å›å¤ bot
			r := regexp.MustCompile(`^\[CQ:reply,id=-?\d+\]\[CQ:at,qq=` + strconv.FormatInt(e.SelfID, 10) + `\]`)
			if !r.MatchString(e.RawMessage) {
				c.Next()
				return
			}

			// è·å–è¢«å›å¤æ¶ˆæ¯
			getMsgParam := api.GetMsgParam{}
			getMsgReturn, err := api.GetMsg(getMsgParam)
			if err != nil {
				logger.Error("è·å–è¢«å›å¤æ¶ˆæ¯å¤±è´¥", zap.String("requestID", requestID), zap.Error(err))
				c.Abort()
				return
			}

			// åŒ¹é…å¹¶è·å– SessionID
			toMatch := getMsgReturn.RawMessage[strings.LastIndex(e.RawMessage, "========================"):]
			r = regexp.MustCompile(`^========================\nSessionID: (fw-r-[fg].+)\nRequestID: [0-9a-fA-F-]{36}`)
			matches := r.FindStringSubmatch(toMatch)
			if len(matches) <= 1 {
				c.Next()
				return
			}
			sessionID := matches[1]

			// è·å–é€šçŸ¥ç±»å‹å’ŒåŸé€šçŸ¥ Flag
			parts := strings.Split(sessionID, "-")
			if len(parts) < 4 {
				logger.Error("è·å–é€šçŸ¥ç±»å‹å’ŒåŸé€šçŸ¥ Flag å¤±è´¥ï¼šæ­£åˆ™æ•è·å¼‚å¸¸", zap.String("requestID", requestID))

				c.Abort()
				return
			}
			noticeType := parts[2]
			flag := parts[3]

			// å¯¹äº friend ç±»å‹è¯·æ±‚
			if noticeType == "f" {
				// è·å–å“åº”æ“ä½œ
				// A/D/B/S/R/T é‡Œæš‚æ—¶åªå®ç°äº† A(ccept) å’Œ D(Deny)
				r = regexp.MustCompile(`\b([ADBSRT])\b$`)
				matche := r.FindStringSubmatch(e.RawMessage)
				if matche == nil {
					logger.Error("è·å–å“åº”æ“ä½œå¤±è´¥ï¼šæ­£åˆ™æ— æ•è·", zap.String("requestID", requestID))
				}
				op := matche[1]

				// æ‰§è¡Œæ“ä½œ
				switch op {
				// Accept
				case "A":
					setFriendAddRequestParam := api.SetFriendAddRequestParam{
						Flag:    flag,
						Approve: true,
					}
					err := api.SetFriendAddRequest(setFriendAddRequestParam)
					if err != nil {
						logger.Error("åŒæ„å¥½å‹è¯·æ±‚å¤±è´¥", zap.String("requestID", requestID), zap.Error(err))
						c.Abort()
						return
					}

				// Deny
				case "D":
					setFriendAddRequestParam := api.SetFriendAddRequestParam{
						Flag:    flag,
						Approve: false,
					}
					err := api.SetFriendAddRequest(setFriendAddRequestParam)
					if err != nil {
						logger.Error("æ‹’ç»å¥½å‹è¯·æ±‚å¤±è´¥", zap.String("requestID", requestID), zap.Error(err))
						c.Abort()
						return
					}
				}
			}

			// å¯¹äº group ç±»å‹è¯·æ±‚
			if noticeType == "g" {
				// TODO
			}
		}
	}
}

// newRequestSessionID ç”¨äºç”Ÿæˆ sessionIDã€‚
//
// sessionID ç”¨äºè®°å½•è¯·æ±‚çŠ¶æ€ï¼Œæ–¹ä¾¿ç”¨æˆ·ç›´æ¥å›å¤å¤„ç†ã€‚

// å®ƒç”±å››éƒ¨åˆ†æ„æˆï¼Œå…¶é—´ç”¨è¿å­—ç¬¦è¿æ¥ï¼šç¬¬ä¸€éƒ¨åˆ†å®šå€¼ "fw" è¡¨ç¤ºä¸­é—´ä»¶
// forwardï¼›ç¬¬äºŒéƒ¨åˆ†å®šå€¼ "r" è¡¨ç¤ºæ˜¯è¯·æ±‚ç±»å‹äº‹ä»¶ï¼›ç¬¬ä¸‰éƒ¨åˆ†ç”¨äºåŒºåˆ†
// è¯·æ±‚ç±»å‹ï¼Œ"f" ä»£è¡¨ friendï¼Œ"g" ä»£è¡¨ groupï¼›ç¬¬å››éƒ¨åˆ†æ˜¯è¯·æ±‚ç±»å‹
// äº‹ä»¶è‡ªå¸¦çš„ flag å‚æ•°ï¼Œä½œä¸ºè¯·æ±‚çš„å”¯ä¸€ IDã€‚
func newRequestSessionID(requestType string, flag string) string {
	switch requestType {
	case "friend":
		return "fw-r-f" + flag
	case "group":
		return "fw-r-g" + flag
	default:
		return ""
	}
}

// NewFriendRequestStr æ„é€ å‡ºè½¬å‘æ–°å¥½å‹ç”³è¯·çš„æ¶ˆæ¯å†…å®¹ã€‚
//
// â„¹ï¸ æ”¶åˆ°æ–°çš„å¥½å‹è¯·æ±‚
// =========================
// ã€è¯·æ±‚è€…ã€‘6025868
// ã€éªŒè¯ä¿¡æ¯ã€‘åŠ ä¸ªå¥½å‹å§åŠ ä¸ªå¥½å‹å§åŠ ä¸ªå¥½å‹å§åŠ ä¸ªå¥½å‹å§
// =========================
// âœ…ã€(A)åŒæ„ã€‘ âã€(D)æ‹’ç»ã€‘
// ğŸ…¾ï¸ã€(B)æ‹‰é»‘ã€‘ â­ï¸ã€(S)å¿½ç•¥ã€‘
// ğŸ”„ã€(R)é‡ç°ã€‘ âºï¸ã€(T)è°ƒè¯•ã€‘
// =========================
// Flag: 1696593555000000
// RequestID: ed6a0822-6e20-4965-ae30-e6357da6c111
func newFriendRequestStr(requestID string, sessionID string, userID int64, comment string) string {
	var builder strings.Builder
	builder.WriteString("â„¹ï¸ æ”¶åˆ°æ–°çš„å¥½å‹è¯·æ±‚\n")
	builder.WriteString("=========================\n")
	builder.WriteString(fmt.Sprintf("ã€è¯·æ±‚è€…ã€‘%d\n", userID))
	if comment != "" {
		builder.WriteString(fmt.Sprintf("ã€éªŒè¯ä¿¡æ¯ã€‘%s\n", comment))
	}
	builder.WriteString("=========================\n")
	builder.WriteString("âœ…ã€(A)åŒæ„ã€‘ âã€(D)æ‹’ç»ã€‘\n")
	builder.WriteString("ğŸ…¾ï¸ã€(B)æ‹‰é»‘ã€‘ â­ï¸ã€(S)å¿½ç•¥ã€‘\n")
	builder.WriteString("ğŸ”„ã€(R)é‡ç°ã€‘ âºï¸ã€(T)è°ƒè¯•ã€‘\n")
	builder.WriteString("=========================\n")
	builder.WriteString(fmt.Sprintf("SessionID: %s\n", sessionID))
	builder.WriteString(fmt.Sprintf("RequestID: %s\n", requestID))

	return builder.String()
}

// forwardRequestEvent è½¬å‘ä¸€ä¸ªæ¶ˆæ¯äº‹ä»¶
func forwardRequestEvent(event.MessageEvent) error { return nil }
